{% extends "base.html" %}

{% block title %}Analytics & Visualization - Dengue Risk System{% endblock %}

{% block content %}
<div class="container-fluid" style="background: linear-gradient(135deg, #1e1b4b, #312e81); min-height: 100vh; padding: 20px;">
    <div class="row justify-content-center">
        <div class="col-lg-11">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="display-5 fw-bold text-light mb-3">
                    <i class="fas fa-chart-area me-3 text-primary"></i>Analytics & Insights
                </h1>
                <p class="lead text-light mb-4">Comprehensive data analysis and city comparisons</p>
            </div>

            <!-- Tabbed Interface -->
            <ul class="nav nav-pills nav-fill mb-4" id="analyticsTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview" type="button" role="tab">
                        <i class="fas fa-chart-line me-2"></i>Overview
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="comparison-tab" data-bs-toggle="pill" data-bs-target="#comparison" type="button" role="tab">
                        <i class="fas fa-balance-scale me-2"></i>Compare Cities
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="insights-tab" data-bs-toggle="pill" data-bs-target="#insights" type="button" role="tab">
                        <i class="fas fa-brain me-2"></i>AI Insights
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="analyticsTabContent">
                
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="overview" role="tabpanel">
                    <!-- Quick Stats -->
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card" style="background: linear-gradient(135deg, #105aa5, #499aa8);">
                                <div class="card-body text-center">
                                    <i class="fas fa-virus fa-3x text-light mb-3"></i>
                                    <h3 class="text-light">2,743</h3>
                                    <p class="text-light mb-0">Total Cases</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card" style="background: linear-gradient(135deg, #814a4a, #8daccc);">
                                <div class="card-body text-center">
                                    <i class="fas fa-city fa-3x text-light mb-3"></i>
                                    <h3 class="text-light">12</h3>
                                    <p class="text-light mb-0">Cities Monitored</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card" style="background: linear-gradient(135deg, #61254f, #814a4a);">
                                <div class="card-body text-center">
                                    <i class="fas fa-exclamation-triangle fa-3x text-light mb-3"></i>
                                    <h3 class="text-light">4</h3>
                                    <p class="text-light mb-0">High Risk Areas</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card" style="background: linear-gradient(135deg, #8daccc, #105aa5);">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line fa-3x text-light mb-3"></i>
                                    <h3 class="text-light">+15%</h3>
                                    <p class="text-light mb-0">Week Growth</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Charts -->
                    <div class="row">
                        <div class="col-lg-8 mb-4">
                            <div class="card" style="background: linear-gradient(135deg, #374151, #4b5563);">
                                <div class="card-header" style="background: linear-gradient(135deg, #1f2937, #374151);">
                                    <h5 class="text-light mb-0">
                                        <i class="fas fa-chart-line me-2"></i>Cases Trend (Last 30 Days)
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="overviewChart" height="400"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-4">
                            <div class="card" style="background: linear-gradient(135deg, #374151, #4b5563);">
                                <div class="card-header" style="background: linear-gradient(135deg, #1f2937, #374151);">
                                    <h5 class="text-light mb-0">
                                        <i class="fas fa-map-marked-alt me-2"></i>Risk Distribution
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="riskDistChart" height="400"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comparison Tab -->
                <div class="tab-pane fade" id="comparison" role="tabpanel">
                    <!-- Comparison Controls -->
                    <div class="card mb-4" style="background: linear-gradient(135deg, #374151, #4b5563);">
                        <div class="card-header" style="background: linear-gradient(135deg, #1f2937, #374151);">
                            <h5 class="text-light mb-0">
                                <i class="fas fa-filter me-2"></i>Comparison Settings
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label text-light">Select Cities</label>
                                    <select class="form-control" id="citySelector" multiple>
                                        <option value="bangalore" selected>Bangalore</option>
                                        <option value="mysore" selected>Mysore</option>
                                        <option value="hubli">Hubli</option>
                                        <option value="mangalore">Mangalore</option>
                                        <option value="belgaum">Belgaum</option>
                                        <option value="tumkur">Tumkur</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label text-light">Time Period</label>
                                    <select class="form-control" id="timePeriod">
                                        <option value="week">Last 7 Days</option>
                                        <option value="month" selected>Last 30 Days</option>
                                        <option value="quarter">Last 90 Days</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label text-light">Chart Type</label>
                                    <select class="form-control" id="chartType">
                                        <option value="line" selected>Line Chart</option>
                                        <option value="bar">Bar Chart</option>
                                        <option value="radar">Radar Chart</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="mt-4">
                                        <button class="btn btn-primary w-100" onclick="updateComparison()">
                                            <i class="fas fa-sync me-2"></i>Update
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Comparison Charts -->
                    <div class="row">
                        <div class="col-lg-8 mb-4">
                            <div class="card" style="background: linear-gradient(135deg, #374151, #4b5563);">
                                <div class="card-header" style="background: linear-gradient(135deg, #1f2937, #374151);">
                                    <h5 class="text-light mb-0">
                                        <i class="fas fa-chart-line me-2"></i>City Comparison
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="comparisonChart" height="400"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-4">
                            <div class="card" style="background: linear-gradient(135deg, #374151, #4b5563);">
                                <div class="card-header" style="background: linear-gradient(135deg, #1f2937, #374151);">
                                    <h5 class="text-light mb-0">
                                        <i class="fas fa-trophy me-2"></i>City Rankings
                                    </h5>
                                </div>
                                <div class="card-body" id="cityRankings">
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 rounded" style="background-color: #ef4444; color: white;">
                                        <span><i class="fas fa-medal me-2"></i>Mangalore</span>
                                        <span>89 cases</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 rounded" style="background-color: #f97316; color: white;">
                                        <span><i class="fas fa-medal me-2"></i>Bangalore</span>
                                        <span>67 cases</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 rounded" style="background-color: #eab308; color: white;">
                                        <span><i class="fas fa-medal me-2"></i>Hubli</span>
                                        <span>45 cases</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded" style="background-color: #22c55e; color: white;">
                                        <span><i class="fas fa-medal me-2"></i>Mysore</span>
                                        <span>23 cases</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistical Summary -->
                    <div class="card" style="background: linear-gradient(135deg, #374151, #4b5563);">
                        <div class="card-header" style="background: linear-gradient(135deg, #1f2937, #374151);">
                            <h5 class="text-light mb-0">
                                <i class="fas fa-calculator me-2"></i>Statistical Summary
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 text-center mb-3">
                                    <h4 class="text-primary">67.5</h4>
                                    <small class="text-light">Average Cases</small>
                                </div>
                                <div class="col-md-3 text-center mb-3">
                                    <h4 class="text-warning">23.2</h4>
                                    <small class="text-light">Std Deviation</small>
                                </div>
                                <div class="col-md-3 text-center mb-3">
                                    <h4 class="text-success">0.84</h4>
                                    <small class="text-light">Correlation Coeff</small>
                                </div>
                                <div class="col-md-3 text-center mb-3">
                                    <h4 class="text-info">+12%</h4>
                                    <small class="text-light">Overall Growth</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Insights Tab -->
                <div class="tab-pane fade" id="insights" role="tabpanel" aria-labelledby="insights-tab">
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="card" style="background: linear-gradient(135deg, #374151, #4b5563);">
                                <div class="card-header" style="background: linear-gradient(135deg, #1f2937, #374151);">
                                    <h5 class="text-light mb-0">
                                        <i class="fas fa-robot me-2"></i>AI Predictions
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-lightbulb me-2"></i>Key Insights</h6>
                                        <ul class="mb-0">
                                            <li>Mangalore shows highest risk for next 2 weeks</li>
                                            <li>Weather patterns indicate increased transmission potential</li>
                                            <li>Early intervention recommended for Bangalore</li>
                                        </ul>
                                    </div>
                                    <div style="position: relative; height: 300px; width: 100%;">
                                        <canvas id="predictionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <div class="card" style="background: linear-gradient(135deg, #374151, #4b5563);">
                                <div class="card-header" style="background: linear-gradient(135deg, #1f2937, #374151);">
                                    <h5 class="text-light mb-0">
                                        <i class="fas fa-link me-2"></i>Weather Correlation
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <h6 class="text-warning mb-3">Environmental Factors</h6>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between text-light mb-1">
                                            <span>Humidity vs Cases</span>
                                            <span class="text-info">0.89</span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-info" style="width: 89%"></div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between text-light mb-1">
                                            <span>Temperature vs Cases</span>
                                            <span class="text-warning">0.76</span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-warning" style="width: 76%"></div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between text-light mb-1">
                                            <span>Rainfall vs Cases</span>
                                            <span class="text-success">0.64</span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-success" style="width: 64%"></div>
                                        </div>
                                    </div>
                                    <div style="position: relative; height: 200px; width: 100%;">
                                        <canvas id="correlationChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Analysis Summary -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card" style="background: linear-gradient(135deg, #374151, #4b5563);">
                                <div class="card-header" style="background: linear-gradient(135deg, #1f2937, #374151);">
                                    <h5 class="text-light mb-0">
                                        <i class="fas fa-brain me-2"></i>AI Analysis Summary
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <div class="text-center p-3 rounded" style="background: rgba(16, 90, 165, 0.2);">
                                                <i class="fas fa-chart-line fa-2x text-primary mb-2"></i>
                                                <h6 class="text-light">Trend Analysis</h6>
                                                <p class="small text-light mb-0">15% increase in dengue cases predicted for next month based on current patterns</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="text-center p-3 rounded" style="background: rgba(129, 74, 74, 0.2);">
                                                <i class="fas fa-map-marker-alt fa-2x text-warning mb-2"></i>
                                                <h6 class="text-light">Hotspot Detection</h6>
                                                <p class="small text-light mb-0">Mangalore and Hubli identified as high-priority surveillance zones</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="text-center p-3 rounded" style="background: rgba(97, 37, 79, 0.2);">
                                                <i class="fas fa-shield-alt fa-2x text-success mb-2"></i>
                                                <h6 class="text-light">Risk Assessment</h6>
                                                <p class="small text-light mb-0">Enhanced vector control measures recommended for coastal areas</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let overviewChart, riskDistChart, comparisonChart, predictionChart, correlationChart;

function initializeCharts() {
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js not loaded');
        setTimeout(initializeCharts, 1000);
        return;
    }

    try {
        // Overview Chart
        const overviewCtx = document.getElementById('overviewChart');
        if (overviewCtx) {
            overviewChart = new Chart(overviewCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['Day 1', 'Day 5', 'Day 10', 'Day 15', 'Day 20', 'Day 25', 'Day 30'],
                    datasets: [{
                        label: 'Total Cases',
                        data: [120, 135, 142, 158, 167, 185, 198],
                        borderColor: '#105aa5',
                        backgroundColor: 'rgba(16, 90, 165, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        // Risk Distribution Chart
        const riskCtx = document.getElementById('riskDistChart');
        if (riskCtx) {
            riskDistChart = new Chart(riskCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Very High', 'High', 'Moderate', 'Low'],
                    datasets: [{
                        data: [25, 35, 30, 10],
                        backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e'],
                        borderWidth: 2,
                        borderColor: '#374151'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#fff' }
                        }
                    }
                }
            });
        }

        // Comparison Chart
        const compCtx = document.getElementById('comparisonChart');
        if (compCtx) {
            comparisonChart = new Chart(compCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [
                        {
                            label: 'Bangalore',
                            data: [45, 55, 67, 72],
                            borderColor: '#105aa5',
                            backgroundColor: 'rgba(16, 90, 165, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Mysore',
                            data: [67, 76, 89, 95],
                            borderColor: '#814a4a',
                            backgroundColor: 'rgba(129, 74, 74, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        // Prediction Chart
        const predCtx = document.getElementById('predictionChart');
        if (predCtx) {
            predictionChart = new Chart(predCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Current Week', 'Next Week', 'Week +2', 'Week +3'],
                    datasets: [{
                        label: 'Predicted Cases',
                        data: [89, 94, 87, 92],
                        backgroundColor: 'rgba(16, 90, 165, 0.8)',
                        borderColor: '#105aa5',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        // Correlation Chart
        const corrCtx = document.getElementById('correlationChart');
        if (corrCtx) {
            correlationChart = new Chart(corrCtx.getContext('2d'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Humidity vs Cases',
                        data: [
                            {x: 75, y: 45}, {x: 82, y: 67}, {x: 68, y: 34}, 
                            {x: 79, y: 56}, {x: 85, y: 78}, {x: 72, y: 42}
                        ],
                        backgroundColor: 'rgba(23, 162, 184, 0.6)',
                        borderColor: '#17a2b8'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Cases',
                                color: '#fff'
                            },
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Humidity (%)',
                                color: '#fff'
                            },
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }
        
        console.log('All charts initialized successfully');
    } catch (error) {
        console.error('Error initializing charts:', error);
    }
}

function updateComparison() {
    try {
        // Update comparison chart with new data
        if (comparisonChart) {
            comparisonChart.data.datasets.forEach(dataset => {
                dataset.data = dataset.data.map(() => Math.floor(Math.random() * 100) + 20);
            });
            comparisonChart.update();
        }
        console.log('Comparison updated successfully');
    } catch (error) {
        console.error('Error updating comparison:', error);
    }
}

// Initialize charts when page loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initializeCharts, 500);
        setupTabSwitching();
    });
} else {
    setTimeout(initializeCharts, 500);
    setupTabSwitching();
}

// Setup proper tab switching without scroll issues
function setupTabSwitching() {
    const tabButtons = document.querySelectorAll('[data-bs-toggle="pill"]');
    tabButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const currentY = window.scrollY;
            
            // Manually activate the tab
            const targetId = this.getAttribute('data-bs-target');
            const targetPane = document.querySelector(targetId);
            
            // Hide all tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('show', 'active');
            });
            
            // Remove active class from all buttons
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activate the clicked tab
            this.classList.add('active');
            if (targetPane) {
                targetPane.classList.add('show', 'active');
                
                // Resize charts after tab is shown
                setTimeout(() => {
                    document.querySelectorAll('canvas').forEach(canvas => {
                        const chart = Chart.getChart(canvas);
                        if (chart && typeof chart.resize === 'function') {
                            chart.resize();
                        }
                    });
                    // Maintain scroll position
                    window.scrollTo({ top: currentY, behavior: 'auto' });
                }, 100);
            }
        });
    });
}

// Tab switching handler to reinitialize charts
document.addEventListener('click', function(e) {
    if (e.target.matches('[data-bs-toggle="pill"]')) {
        // Preserve current scroll position to avoid jumping when tab content is long
        const currentY = window.scrollY || window.pageYOffset;
        // Use Bootstrap's shown event to trigger resize after the tab is fully shown
        setTimeout(function() {
            try {
                // Resize all existing Chart.js charts
                document.querySelectorAll('canvas').forEach(canvas => {
                    try {
                        const chart = Chart.getChart(canvas);
                        if (chart && typeof chart.resize === 'function') chart.resize();
                    } catch (err) {
                        // ignore individual canvas errors
                    }
                });
            } catch (err) {
                console.error('Error resizing charts after tab switch', err);
            }

            // Restore scroll position to prevent the page from jumping down
            setTimeout(() => { window.scrollTo({ top: currentY, left: 0, behavior: 'auto' }); }, 50);
        }, 300);
    }
});

// Also listen for Bootstrap tab shown events (more reliable)
document.querySelectorAll('[data-bs-toggle="pill"]').forEach(btn => {
    btn.addEventListener('shown.bs.tab', function(e) {
        const currentY = window.scrollY || window.pageYOffset;
        // small delay to allow rendering
        setTimeout(() => {
            document.querySelectorAll('canvas').forEach(canvas => {
                try {
                    const chart = Chart.getChart(canvas);
                    if (chart && typeof chart.resize === 'function') chart.resize();
                } catch (err) {}
            });
            window.scrollTo({ top: currentY, left: 0, behavior: 'auto' });
        }, 120);
    });
});
</script>

            <!-- Real Data Overview Cards -->
            <div class="row g-4 mb-5">
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 h-100 shadow-lg" style="border-radius: 1rem; background: #00ffff; border: 3px solid #ffffff; box-shadow: 0 8px 25px rgba(0, 255, 255, 0.7);">
                        <div class="card-body p-4 text-center">
                            <div class="mb-3">
                                <div class="d-inline-flex align-items-center justify-content-center rounded-circle shadow-lg" style="width: 80px; height: 80px; background: #000000; border: 3px solid #ffffff;">
                                    <i class="fas fa-virus" style="font-size: 2.2rem; color: #00ffff;"></i>
                                </div>
                            </div>
                            <h2 class="fw-bold mb-1" style="color: #000000; text-shadow: 2px 2px 4px rgba(255,255,255,0.8); font-size: 2.5rem;">
                                {{ charts_data.statistics.total_cases if charts_data and charts_data.statistics else 'N/A' }}
                            </h2>
                            <p class="mb-2 fw-bold" style="color: #000000; font-size: 1.1rem; text-shadow: 1px 1px 2px rgba(255,255,255,0.6);">Total Cases</p>
                            <small style="color: #000000; font-weight: 700;">
                                <i class="fas fa-calendar me-1"></i>
                                All recorded data
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 h-100 shadow-lg" style="border-radius: 1rem; background: #ff00ff; border: 3px solid #ffffff; box-shadow: 0 8px 25px rgba(255, 0, 255, 0.7);">
                        <div class="card-body p-4 text-center">
                            <div class="mb-3">
                                <div class="d-inline-flex align-items-center justify-content-center rounded-circle shadow-lg" style="width: 80px; height: 80px; background: #000000; border: 3px solid #ffffff;">
                                    <i class="fas fa-chart-line" style="font-size: 2.2rem; color: #ff00ff;"></i>
                                </div>
                            </div>
                            <h2 class="fw-bold mb-1" style="color: #ffffff; text-shadow: 3px 3px 6px rgba(0,0,0,0.8); font-size: 2.5rem;">
                                {{ charts_data.statistics.avg_daily_cases if charts_data and charts_data.statistics else 'N/A' }}
                            </h2>
                            <p class="mb-2 fw-bold" style="color: #ffffff; font-size: 1.1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.6);">Avg Daily Cases</p>
                            <small style="color: #ffffff; font-weight: 700;">
                                <i class="fas fa-clock me-1"></i>
                                November 28, 2025
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 h-100 shadow-lg" style="border-radius: 1rem; background: #ffff00; border: 3px solid #000000; box-shadow: 0 8px 25px rgba(255, 255, 0, 0.7);">
                        <div class="card-body p-4 text-center">
                            <div class="mb-3">
                                <div class="d-inline-flex align-items-center justify-content-center rounded-circle shadow-lg" style="width: 80px; height: 80px; background: #000000; border: 3px solid #ffffff;">
                                    <i class="fas fa-city" style="font-size: 2.2rem; color: #ffff00;"></i>
                                </div>
                            </div>
                            <h2 class="fw-bold mb-1" style="color: #000000; text-shadow: 2px 2px 4px rgba(255,255,255,0.8); font-size: 1.8rem;">Bangalore</h2>
                            <p class="mb-2 fw-bold" style="color: #000000; font-size: 1.1rem; text-shadow: 1px 1px 2px rgba(255,255,255,0.6);">Highest Risk</p>
                            <small style="color: #000000; font-weight: 700;">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                Priority monitoring
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 h-100 shadow-lg" style="border-radius: 1rem; background: #ff6600; border: 3px solid #ffffff; box-shadow: 0 8px 25px rgba(255, 102, 0, 0.7);">
                        <div class="card-body p-4 text-center">
                            <div class="mb-3">
                                <div class="d-inline-flex align-items-center justify-content-center rounded-circle shadow-lg" style="width: 80px; height: 80px; background: #ffffff; border: 3px solid #000000;">
                                    <i class="fas fa-shield-check" style="font-size: 2.2rem; color: #ff6600;"></i>
                                </div>
                            </div>
                            <h2 class="fw-bold mb-1" style="color: #ffffff; text-shadow: 3px 3px 6px rgba(0,0,0,0.8); font-size: 1.4rem;">
                                {{ charts_data.statistics.highest_risk_city if charts_data and charts_data.statistics else 'N/A' }}
                            </h2>
                            <p class="mb-2 fw-bold" style="color: #ffffff; font-size: 1.1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.6);">Highest Risk City</p>
                            <small style="color: #ffffff; font-weight: 700;">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                Needs attention
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            {% if charts_data %}
                <!-- Real Data Charts Section -->
                <div class="row g-4 mb-5">
                    <!-- Time Series Chart -->
                    {% if charts_data.time_series %}
                        <div class="col-12">
                            <div class="card border-0 shadow-lg" style="border-radius: 1rem; background: #000000; border: 3px solid #ffffff; box-shadow: 0 8px 25px rgba(255, 255, 255, 0.3);">
                                <div class="card-header bg-transparent border-0 py-4">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <div class="d-inline-flex align-items-center justify-content-center rounded-circle shadow-lg" style="width: 60px; height: 60px; background: #ffffff; border: 3px solid #000000;">
                                                <i class="fas fa-chart-line" style="font-size: 1.5rem; color: #000000;"></i>
                                            </div>
                                        </div>
                                        <div>
                                            <h5 class="mb-1 fw-bold" style="color: #ffffff; text-shadow: none;">Temporal Trend Analysis</h5>
                                            <small class="fw-semibold" style="color: #cccccc;">Dengue cases across 12 Karnataka cities over time</small>
                                            <div class="mt-2">
                                                <small style="color: #aaaaaa; font-size: 0.8rem;">
                                                    <i class="fas fa-map-marker-alt me-1"></i>
                                                    Includes: Bangalore, Mysore, Hubli, Mangalore, Belgaum, Tumkur, Davangere, Bellary, Bijapur, Shimoga, Gulbarga, Hassan
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                </div>
                                <div class="card-body p-4" style="background: #ffffff;">
                                    <div class="text-center">
                                        <img src="data:image/png;base64,{{ charts_data.time_series }}" 
                                             class="img-fluid" 
                                             alt="Time Series Chart"
                                             style="max-height: 400px; border-radius: 0.5rem; background: white;"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div style="display: none;" class="text-center p-4">
                                            <i class="fas fa-chart-line text-muted" style="font-size: 3rem;"></i>
                                            <h5 class="text-muted mt-3">Chart Loading...</h5>
                                            <p class="text-muted">Please refresh if chart doesn't appear</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="col-12">
                            <div class="card border" style="border-radius: 0.75rem; border-color: #e5e7eb;">
                                <div class="card-body p-4 text-center">
                                    <i class="fas fa-chart-line text-muted" style="font-size: 3rem;"></i>
                                    <h5 class="text-muted mt-3">Time Series Chart</h5>
                                    <p class="text-muted">Chart data is being generated...</p>
                                    <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">
                                        <i class="fas fa-sync me-1"></i>Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <div class="col-lg-12">
                        {% if charts_data.location %}
                            <div class="card border-0 h-100 shadow-lg" style="border-radius: 1rem; background: #000000; border: 3px solid #00aa00; box-shadow: 0 8px 25px rgba(0, 170, 0, 0.6);">
                                <div class="card-header bg-transparent border-0 py-4">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <div class="d-inline-flex align-items-center justify-content-center rounded-circle shadow-lg" style="width: 65px; height: 65px; background: #ffffff; border: 3px solid #00aa00;">
                                                <i class="fas fa-map-marker-alt" style="font-size: 1.5rem; color: #000000;"></i>
                                            </div>
                                        </div>
                                        <div>
                                            <h5 class="mb-1 fw-bold" style="color: #ffffff; text-shadow: 3px 3px 6px rgba(0,0,0,0.8);">Geographic Distribution</h5>
                                            <small style="color: #ffffff; font-weight: 700;">Which Karnataka cities have the highest dengue cases</small>
                                            <div class="mt-2">
                                                <small style="color: #cccccc; font-size: 0.8rem;">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Shows total cases by city ranked highest to lowest
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-4">
                                    <div class="text-center">
                                        <img src="data:image/png;base64,{{ charts_data.location }}" 
                                             class="img-fluid rounded shadow-lg" 
                                             alt="Location Chart"
                                             style="max-height: 350px; background: white; border: 3px solid #00aa00;"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div style="display: none;" class="text-center p-3">
                                            <i class="fas fa-map-marker-alt" style="font-size: 2.5rem; color: #ffffff;"></i>
                                            <p class="mt-2 fw-bold" style="color: #ffffff;">Chart loading error</p>
                                            <button class="btn btn-outline-light btn-sm" onclick="location.reload()">
                                                <i class="fas fa-sync me-1"></i>Retry
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="card border-0 h-100 shadow-lg" style="border-radius: 1rem; background: linear-gradient(135deg, #374151 0%, #1f2937 100%); border: 3px solid #6b7280;">
                                <div class="card-body p-4 text-center d-flex align-items-center justify-content-center">
                                    <div>
                                        <i class="fas fa-map-marker-alt" style="font-size: 3rem; color: #d1d5db;"></i>
                                        <h5 class="mt-3 fw-bold" style="color: #f9fafb;">Location Chart</h5>
                                        <p style="color: #d1d5db;">Loading geographic data...</p>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>


                </div>
                </div>
            {% else %}
                <!-- Enhanced No Data State -->
                <div class="card border" style="border-radius: 0.75rem; border-color: #e5e7eb;">
                    <div class="card-body text-center py-5">
                        <div class="mb-4">
                            <div class="d-inline-flex align-items-center justify-content-center bg-light rounded-circle" style="width: 100px; height: 100px;">
                                <i class="fas fa-chart-line text-secondary" style="font-size: 2.5rem;"></i>
                            </div>
                        </div>
                        <h4 class="text-dark mb-3">Analytics Loading</h4>
                        <p class="text-muted mb-4">
                            Charts and visualizations are being generated from real data
                        </p>
                        <div class="alert alert-light border mb-4">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-info-circle text-primary me-3 mt-1"></i>
                                <div class="text-start">
                                    <h6 class="mb-2 text-primary">Data Requirements</h6>
                                    <ul class="small text-muted mb-0">
                                        <li>Dengue case records from datasets/dengue_cases.csv</li>
                                        <li>Weather history from datasets/weather_history.csv</li>
                                        <li>Minimum data points needed for trend analysis</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary px-4 py-2" onclick="location.reload()" style="border-radius: 0.5rem;">
                            <i class="fas fa-sync me-2"></i>Refresh Analytics
                        </button>
                    </div>
                </div>
            {% endif %}

            <!-- Clean Interactive Map -->
            <div class="card border-0 mb-5" style="border-radius: 1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                <div class="card-header bg-white border-0 py-4" style="border-radius: 1rem 1rem 0 0;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <div class="d-inline-flex align-items-center justify-content-center bg-warning bg-opacity-10 rounded-circle" style="width: 50px; height: 50px;">
                                    <i class="fas fa-globe text-warning" style="font-size: 1.2rem;"></i>
                                </div>
                            </div>
                            <div>
                                <h5 class="mb-1 fw-bold text-dark">Interactive Geographic Map</h5>
                                <small class="text-muted">Real-time dengue hotspots across Karnataka</small>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="resetMapView()">
                                <i class="fas fa-home me-1"></i>Reset
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshMapData()">
                                <i class="fas fa-sync me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="height: 450px; width: 100%; border-radius: 0 0 1rem 1rem;"></div>
                </div>
                <div class="card-footer bg-light border-0 py-3" style="border-radius: 0 0 1rem 1rem;">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-2"></i>
                                Click markers for detailed information  Risk levels: 
                                <span class="badge bg-danger text-white ms-1">High (300+)</span>
                                <span class="badge bg-warning text-dark ms-1">Medium (201-300)</span>
                                <span class="badge bg-info text-white ms-1">Low (101-200)</span>
                                <span class="badge bg-success text-white ms-1">Minimal (1-100)</span>
                                <span class="badge bg-secondary text-white ms-1">No Cases (0)</span>
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                All 12 Karnataka cities
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Analytics Summary Grid -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card h-100 border-0" style="background: linear-gradient(135deg, #667eea, #764ba2); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);">
                        <div class="card-body text-white text-center p-4">
                            <div class="mb-3">
                                <i class="fas fa-chart-bar fa-3x"></i>
                            </div>
                            <h5 class="fw-bold mb-3"> Data Analysis Engine</h5>
                            <div class="mb-3">
                                <div class="progress bg-white bg-opacity-20" style="height: 8px;">
                                    <div class="progress-bar bg-white" role="progressbar" style="width: 85%"></div>
                                </div>
                                <small class="opacity-90 mt-2 d-block">Processing: 85% Complete</small>
                            </div>
                            <ul class="list-unstyled small text-start opacity-90">
                                <li class="mb-2"><i class="fas fa-check text-white me-2"></i>Statistical trend analysis</li>
                                <li class="mb-2"><i class="fas fa-check text-white me-2"></i>Pattern recognition algorithms</li>
                                <li class="mb-2"><i class="fas fa-check text-white me-2"></i>Predictive modeling</li>
                                <li class="mb-0"><i class="fas fa-check text-white me-2"></i>Risk assessment metrics</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 mb-3">
                    <div class="card h-100 border-0" style="background: linear-gradient(135deg, #4ecdc4, #44a08d); box-shadow: 0 8px 25px rgba(78, 205, 196, 0.2);">
                        <div class="card-body text-white text-center p-4">
                            <div class="mb-3">
                                <i class="fas fa-map fa-3x"></i>
                            </div>
                            <h5 class="fw-bold mb-3"> Spatial Intelligence</h5>
                            <div class="mb-3">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <h6 class="fw-bold">12</h6>
                                        <small class="opacity-90">Cities</small>
                                    </div>
                                    <div class="col-6">
                                        <h6 class="fw-bold">168</h6>
                                        <small class="opacity-90">Cases</small>
                                    </div>
                                </div>
                            </div>
                            <ul class="list-unstyled small text-start opacity-90">
                                <li class="mb-2"><i class="fas fa-map-marker-alt text-white me-2"></i>Geographic hotspot detection</li>
                                <li class="mb-2"><i class="fas fa-city text-white me-2"></i>Urban vs rural analysis</li>
                                <li class="mb-2"><i class="fas fa-route text-white me-2"></i>Transmission path mapping</li>
                                <li class="mb-0"><i class="fas fa-shield-alt text-white me-2"></i>Containment zone planning</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 mb-3">
                    <div class="card h-100 border-0" style="background: linear-gradient(135deg, #ff6b6b, #ee5a52); box-shadow: 0 8px 25px rgba(255, 107, 107, 0.2);">
                        <div class="card-body text-white text-center p-4">
                            <div class="mb-3">
                                <i class="fas fa-clock fa-3x"></i>
                            </div>
                            <h5 class="fw-bold mb-3"> Temporal Patterns</h5>
                            <div class="mb-3">
                                <span class="badge bg-white text-danger px-3 py-2 fw-bold">PEAK SEASON</span>
                            </div>
                            <ul class="list-unstyled small text-start opacity-90">
                                <li class="mb-2"><i class="fas fa-calendar text-white me-2"></i>Monsoon correlation analysis</li>
                                <li class="mb-2"><i class="fas fa-chart-line text-white me-2"></i>Seasonal trend tracking</li>
                                <li class="mb-2"><i class="fas fa-clock text-white me-2"></i>Early warning indicators</li>
                                <li class="mb-0"><i class="fas fa-bell text-white me-2"></i>Outbreak prediction alerts</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Key Insights Section -->
            <div class="card mb-4 border-0" style="box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                <div class="card-header text-white" style="background: linear-gradient(135deg, #ffc107, #ff8f00);">
                    <div class="d-flex align-items-center">
                        <div class="p-2 bg-white bg-opacity-20 rounded-circle me-3">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div>
                            <h5 class="mb-0 fw-bold"> Intelligence Insights & Patterns</h5>
                            <small class="opacity-90">Data-driven observations from Karnataka surveillance</small>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <div class="h-100 p-3 border-start border-primary border-4">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-calendar-alt me-2"></i> Seasonal Analysis
                                </h6>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small">Monsoon Risk</span>
                                        <span class="badge bg-danger">High</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-gradient" style="width: 85%; background: linear-gradient(90deg, #ffc107, #ff6b6b);"></div>
                                    </div>
                                </div>
                                <ul class="small text-muted mb-0">
                                    <li class="mb-2"> Peak cases during monsoon months</li>
                                    <li class="mb-2"> Post-monsoon secondary peaks</li>
                                    <li class="mb-2"> Lower incidence in winter</li>
                                    <li class="mb-0"> Pre-monsoon preparation critical</li>
                                </ul>
                            </div>
                        </div>
                        

                                </div>
                                <ul class="small text-muted mb-0">
                                    <li class="mb-2"> Temperature range: 25-30C optimal</li>
                                    <li class="mb-2"> Humidity >70% increases risk</li>
                                    <li class="mb-2"> Rainfall creates breeding sites</li>
                                    <li class="mb-0"> Urban heat islands amplify risk</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-4">
                            <div class="h-100 p-3 border-start border-info border-4">
                                <h6 class="text-info mb-3">
                                    <i class="fas fa-city me-2"></i> Geographic Intelligence
                                </h6>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small">Urban Risk</span>
                                        <span class="badge bg-warning">Medium-High</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-gradient" style="width: 70%; background: linear-gradient(90deg, #4ecdc4, #667eea);"></div>
                                    </div>
                                </div>
                                <ul class="small text-muted mb-0">
                                    <li class="mb-2"> Higher cases in urban areas</li>
                                    <li class="mb-2"> Coastal regions more affected</li>
                                    <li class="mb-2"> Poor drainage increases risk</li>
                                    <li class="mb-0"> Construction zones vulnerable</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Alert Banner -->
                    <div class="mt-4 p-3 rounded" style="background: linear-gradient(135deg, #fff3cd, #ffeaa7);">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle text-warning fa-2x me-3"></i>
                            <div>
                                <h6 class="mb-1 text-dark"> Current Advisory</h6>
                                <p class="mb-0 small text-muted">
                                    Based on current data patterns, **Bangalore** and surrounding Karnataka urban areas show elevated risk. 
                                    Enhanced surveillance and vector control measures recommended during monsoon period.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modern Navigation & Actions -->
            <div class="card border-0" style="border-radius: 0.75rem; background: linear-gradient(135deg, #f9fafb, #f3f4f6); border: 1px solid #e5e7eb;">
                <div class="card-body text-center py-4">
                    <h5 class="mb-4 text-dark fw-bold">Explore More Features</h5>
                    <div class="row justify-content-center">
                        <div class="col-lg-10">
                            <div class="d-flex flex-wrap justify-content-center gap-3">
                                <a href="{{ url_for('index') }}" class="btn px-4 py-2" style="border-radius: 0.5rem; background: #3b82f6; color: white; border: none;">
                                    <i class="fas fa-home me-2"></i>Dashboard
                                </a>
                                <a href="{{ url_for('local_alert_route') }}" class="btn px-4 py-2" style="border-radius: 0.5rem; background: #f59e0b; color: white; border: none;">
                                    <i class="fas fa-map-marker-alt me-2"></i>Local Alerts
                                </a>
                                <a href="{{ url_for('weather_prediction') }}" class="btn px-4 py-2" style="border-radius: 0.5rem; background: #10b981; color: white; border: none;">
                                    <i class="fas fa-cloud-sun me-2"></i>Weather
                                </a>
                                <a href="{{ url_for('risk_calculator_route') }}" class="btn px-4 py-2" style="border-radius: 0.5rem; background: #8b5cf6; color: white; border: none;">
                                    <i class="fas fa-calculator me-2"></i>Risk Calculator
                                </a>
                                <button class="btn px-4 py-2" onclick="refreshAnalytics()" style="border-radius: 0.5rem; background: #6b7280; color: white; border: none;">
                                    <i class="fas fa-sync me-2"></i>Refresh Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global map variable
let map;

// Initialize enhanced map with better styling
function initMap() {
    // Default center on Karnataka, India
    map = L.map('map', {
        zoomControl: true,
        scrollWheelZoom: true,
        doubleClickZoom: true,
        dragging: true
    }).setView([15.3173, 75.7139], 7);
    
    // Add enhanced tile layer with better styling
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors',
        maxZoom: 18,
        tileSize: 256,
        zoomOffset: 0
    }).addTo(map);
    
    // Custom marker styles for all risk levels including cities with no cases
    const markerStyles = {
        high: { color: '#dc2626', fillColor: '#ef4444', fillOpacity: 0.9, radius: 14, weight: 3 },
        medium: { color: '#ea580c', fillColor: '#f97316', fillOpacity: 0.8, radius: 12, weight: 2 },
        low: { color: '#0ea5e9', fillColor: '#38bdf8', fillOpacity: 0.7, radius: 10, weight: 2 },
        minimal: { color: '#16a34a', fillColor: '#4ade80', fillOpacity: 0.6, radius: 8, weight: 2 },
        default: { color: '#6b7280', fillColor: '#d1d5db', fillOpacity: 0.5, radius: 6, weight: 1 }
    };
    
    // Load and display map data
    fetch('/api/map-data')
        .then(response => response.json())
        .then(data => {
            if (data.locations && data.locations.length > 0) {
                data.locations.forEach(location => {
                    // Determine risk level and marker style based on case count
                    let riskLevel = 'default';
                    let riskText = 'No Cases';
                    let riskBadgeClass = 'secondary';
                    
                    if (location.cases > 300) {
                        riskLevel = 'high';
                        riskText = 'High Risk';
                        riskBadgeClass = 'danger';
                    } else if (location.cases > 200) {
                        riskLevel = 'medium';
                        riskText = 'Medium Risk';
                        riskBadgeClass = 'warning';
                    } else if (location.cases > 100) {
                        riskLevel = 'low';
                        riskText = 'Low Risk';
                        riskBadgeClass = 'info';
                    } else if (location.cases > 0) {
                        riskLevel = 'minimal';
                        riskText = 'Minimal Cases';
                        riskBadgeClass = 'success';
                    }
                    
                    // Create enhanced circular marker
                    const marker = L.circleMarker([location.lat, location.lng], markerStyles[riskLevel])
                        .addTo(map);
                    
                    // Create enhanced popup content
                    const popupContent = `
                        <div class="text-center" style="min-width: 200px;">
                            <h6 class="text-primary fw-bold mb-2">${location.name}</h6>
                            <div class="row mb-2">
                                <div class="col-6">
                                    <div class="text-muted small">Cases</div>
                                    <div class="fw-bold text-danger">${location.cases}</div>
                                </div>
                                <div class="col-6">
                                    <div class="text-muted small">State</div>
                                    <div class="fw-bold">${location.state}</div>
                                </div>
                            </div>
                            <span class="badge bg-${riskBadgeClass} px-3 py-1">
                                ${riskText}
                            </span>
                            <hr class="my-2">
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                Click for detailed analytics
                            </small>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    
                    // Add click event for detailed view
                    marker.on('click', function() {
                        console.log(`Viewing details for ${location.name}`);
                    });
                });
                
                // Fit map to show all markers
                const group = new L.featureGroup(map._layers);
                if (Object.keys(group._layers).length > 0) {
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            } else {
                // Show "no data" marker with enhanced styling
                const noDataMarker = L.circleMarker([15.3173, 75.7139], {
                    color: '#6c757d',
                    fillColor: '#e9ecef',
                    fillOpacity: 0.8,
                    radius: 15
                }).addTo(map);
                
                noDataMarker.bindPopup(`
                    <div class="text-center p-2">
                        <i class="fas fa-info-circle text-primary fa-2x mb-2"></i>
                        <h6 class="text-primary">No Map Data Available</h6>
                        <p class="small text-muted mb-0">
                            Map will show dengue case locations when data becomes available.
                        </p>
                    </div>
                `).openPopup();
            }
        })
        .catch(error => {
            console.error('Error loading map data:', error);
            const errorMarker = L.circleMarker([15.3173, 75.7139], {
                color: '#dc3545',
                fillColor: '#ff6b6b',
                fillOpacity: 0.8,
                radius: 15
            }).addTo(map);
            
            errorMarker.bindPopup(`
                <div class="text-center p-2 text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <h6>Error Loading Data</h6>
                    <p class="small mb-0">Unable to load map data. Please try refreshing the page.</p>
                </div>
            `).openPopup();
        });
}

// Reset map view to default position
function resetMapView() {
    if (map) {
        map.setView([15.3173, 75.7139], 7);
        console.log('Map view reset to Karnataka');
    }
}

// Refresh map data
function refreshMapData() {
    if (map) {
        // Clear existing markers
        map.eachLayer(function(layer) {
            if (layer instanceof L.CircleMarker) {
                map.removeLayer(layer);
            }
        });
        
        // Show loading indicator
        const loadingMarker = L.circleMarker([15.3173, 75.7139], {
            color: '#007bff',
            fillColor: '#4dabf7',
            fillOpacity: 0.8,
            radius: 10
        }).addTo(map);
        
        loadingMarker.bindPopup(`
            <div class="text-center p-2">
                <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                <span class="small">Refreshing data...</span>
            </div>
        `).openPopup();
        
        // Reload data after a short delay
        setTimeout(() => {
            map.removeLayer(loadingMarker);
            initMap();
        }, 1000);
        
        console.log('Refreshing map data...');
    }
}

// Refresh entire analytics dashboard
function refreshAnalytics() {
    // Show loading state
    const refreshBtn = event.target;
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';
    refreshBtn.disabled = true;
    
    // Simulate data refresh
    setTimeout(() => {
        location.reload();
    }, 1500);
    
    console.log('Refreshing analytics dashboard...');
}

// Page load animations
function initPageAnimations() {
    // Fade in cards with delay
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Animate progress bars
    const progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.transition = 'width 1s ease-in-out';
            bar.style.width = width;
        }, 500);
    });
}

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing enhanced analytics page...');
    initMap();
    initPageAnimations();
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'r' && e.ctrlKey) {
            e.preventDefault();
            refreshAnalytics();
        }
    });
});

// Auto-refresh data every 5 minutes (optional)
// setInterval(refreshMapData, 300000);
</script>
{% endblock %}
